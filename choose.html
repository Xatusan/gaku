<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Choose – Carousel Stable</title>
<style>
  html,body{margin:0;padding:0;background:#0a0f1a;color:#eaf6ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  #err{position:fixed;left:0;right:0;top:0;background:#300;color:#ffd;display:none;padding:8px 12px;z-index:9999;white-space:pre-wrap}

  #stars,#stars2,#stars3{position:fixed;inset:0;z-index:0;pointer-events:none}
  @keyframes animStar{from{transform:translateY(0)}to{transform:translateY(-2000px)}}
  #stars{background-image:
    radial-gradient(1px 1px at 20px 30px,#fff,transparent 60%),
    radial-gradient(1px 1px at 80px 120px,#fff,transparent 60%),
    radial-gradient(1px 1px at 160px 20px,#fff,transparent 60%);
    background-size:200px 200px;animation:animStar 50s linear infinite;opacity:.8}
  #stars2{background-image:
    radial-gradient(2px 2px at 40px 50px,#fff,transparent 60%),
    radial-gradient(2px 2px at 140px 160px,#fff,transparent 60%),
    radial-gradient(2px 2px at 190px 90px,#fff,transparent 60%);
    background-size:220px 220px;animation:animStar 100s linear infinite;opacity:.6}
  #stars3{background-image:
    radial-gradient(3px 3px at 70px 100px,#fff,transparent 60%),
    radial-gradient(3px 3px at 120px 40px,#fff,transparent 60%),
    radial-gradient(3px 3px at 150px 180px,#fff,transparent 60%);
    background-size:260px 260px;animation:animStar 150s linear infinite;opacity:.4}

  #app{position:relative;z-index:1;display:grid;grid-template-columns:1fr 520px;gap:28px;min-height:100vh;align-items:center;padding:28px}
  @media(max-width:1020px){#app{grid-template-columns:1fr}}

  .stage{position:relative;display:flex;align-items:center;justify-content:center;min-height:560px}
  .cards{position:relative;display:flex;align-items:center;justify-content:center;gap:22px;overflow:visible}
  .card{width:200px;height:300px;border-radius:16px;border:1px solid rgba(134,241,255,.25);background:rgba(255,255,255,.05);display:flex;flex-direction:column;overflow:hidden;transition:transform .25s ease, opacity .25s ease, filter .25s ease}
  .card .thumb{height:190px;display:flex;align-items:center;justify-content:center}
  .card .thumb img{max-width:88%;max-height:88%}
  .card .name{margin:auto 10px 10px;padding:6px 10px;border-radius:10px;background:rgba(0,0,30,.5)}
  .card.center{width:380px;height:460px;transform:scale(1.05);z-index:2}
  .card.center .thumb{height:320px}
  .card.center .thumb img{max-width:92%;max-height:95%;filter:drop-shadow(0 8px 20px rgba(249,215,108,.35))}
  .card.side{opacity:.95;filter:brightness(.95)}
  .card.hidden{display:none}
  .nav-btn{position:absolute;top:50%;transform:translateY(-50%);width:52px;height:52px;border-radius:50%;border:1px solid rgba(134,241,255,.5);background:rgba(20,24,40,.98);color:#f9d76c;font-weight:800;font-size:22px;cursor:pointer;z-index:20;box-shadow:0 6px 18px rgba(0,0,0,.45)}
  .nav-left{left:-16px}
  .nav-right{right:-16px}

  /* Hero panel styling */
  .hero{
    background:linear-gradient(135deg,#151a28 60%,#1c2036 100%);
    border:1px solid #23243a;
    border-radius:18px;
    padding:22px;
    min-height:560px;
    display:flex;
    flex-direction:column;
    align-items:center;
    box-sizing:border-box;
    overflow:hidden;
  }
  /* Image container for hero portrait */
  .hero .image-container{
    width:100%;
    height:360px;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-bottom:8px;
  }
  .hero .image-container img{
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    border-radius:12px;
    filter:drop-shadow(0 0 8px rgba(250,216,96,0.5));
    transition:transform .3s;
  }
  .hero .image-container:hover img{ transform:scale(1.02); }
  /* Hero name and flavor text */
  .hero h2{
    margin:12px 0 6px;
    font-size:1.4rem;
    text-align:center;
  }
  .hero p.flavor{
    margin:0 0 8px;
    font-size:.95rem;
    text-align:center;
    opacity:.9;
  }
  /* Name input */
  .name-row{ width:100%; margin-bottom:10px; display:flex; flex-direction:column; align-items:stretch; }
  .name-row label{ font-size:.9rem; margin-bottom:4px; opacity:.85; }
  .name-row input{ width:100%; padding:8px 10px; font-size:1rem; background:rgba(0,0,25,0.6); border:1px solid rgba(134,241,255,0.4); border-radius:8px; color:#eaf6ff; outline:none; transition:border-color .2s; }
  .name-row input:focus{ border-color: rgba(250,216,96,0.6); }
  /* Ability selection chips */
  .abilities-selection{ display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin-bottom:8px; }
  /* Ensure ability chips do not overlap attribute buttons */
  .abilities-selection{ position:relative; z-index:1; }
  .ability-chip{ padding:4px 10px; font-size:.9rem; border-radius:16px; border:1px solid rgba(134,241,255,0.5); background:rgba(0,0,30,0.5); color:#eaf6ff; cursor:pointer; transition: background .25s, box-shadow .25s, border-color .25s; display:inline-flex; align-items:center; gap:6px; }
  /* Ensure ability chips built with <button> reset default button styles */
  .ability-chip{ appearance:none; -webkit-appearance:none; border:1px solid rgba(134,241,255,0.5); background:rgba(0,0,30,0.5); color:#eaf6ff; font-family:inherit; }
  .ability-chip:focus{ outline:none; }
  .ability-chip:hover:not(.selected):not(.disabled){ background: rgba(250,216,96,0.25); border-color: rgba(250,216,96,0.5); box-shadow:0 0 6px rgba(250,216,96,0.35); }
  .ability-chip.selected{
    background: rgba(250,216,96,0.6);
    border-color: rgba(250,216,96,0.8);
    color:#0a0f1a;
    box-shadow: 0 0 8px rgba(250,216,96,0.55), 0 0 12px rgba(134,241,255,0.45);
  }
  .ability-chip.disabled{ opacity:.5; cursor:not-allowed; }
  /* Points remaining */
  .points-remaining{ margin-bottom:4px; font-size:.85rem; opacity:.8; }
  /* Attributes grid */
  .attributes{ width:100%; display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-bottom:8px; }
  .attributes{ position:relative; z-index:2; }
  .attr{ display:flex; align-items:center; justify-content:space-between; padding:6px; background:rgba(0,0,30,0.5); border-radius:8px; font-size:.95rem; }
  .attr .label{ flex:0 0 36px; text-shadow:0 0 6px rgba(106,204,253,0.5); }
  .attr .value{ margin-left:auto; margin-right:6px; font-weight:bold; }
  .attr button.plus{ background:rgba(106,204,253,0.25); border:1px solid rgba(134,241,255,0.5); border-radius:50%; width:26px; height:26px; color:#eaf6ff; font-weight:bold; line-height:1; cursor:pointer; transition: background .3s, box-shadow .3s; }
  .attr button.plus:hover:not(:disabled){ background: rgba(250,216,96,0.35); box-shadow:0 0 6px rgba(250,216,96,0.4); }
  .attr button.plus:disabled{ opacity:.5; cursor:not-allowed; }
  /* Footer continue button */
  .footer{ text-align:center; margin-top:auto; }
  .footer button{ margin-top:8px; padding:10px 24px; background:rgba(106,204,253,0.2); border:2px solid #6accfd; border-radius:24px; color:#eaf6ff; font-size:1rem; cursor:pointer; transition: background .3s, box-shadow .3s; }
  .footer button:hover:not(:disabled){ background: rgba(250,216,96,0.25); box-shadow: 0 0 12px rgba(250,216,96,0.45), 0 0 18px rgba(106,204,253,0.4); }
  .footer button:disabled{ opacity:.5; cursor:not-allowed; }
  /* Overlay styling */
  .overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,8,20,0.95); z-index:100; pointer-events:none; opacity:1; filter:blur(8px); transform:scale(1.1); transition: opacity 1.4s ease-out, filter 1.4s ease-out, transform 1.4s ease-out; }
  .overlay h1{ font-size:clamp(2rem,6vw + .5rem,4rem); text-shadow:0 0 18px #6accfd, 0 0 40px #6accfd; animation:overlaypulse 4s infinite alternate; }
  @keyframes overlaypulse{ from{ opacity:0.85; } to{ opacity:1; } }
  /* Summary modal */
  .modal{ position:fixed; inset:0; background:rgba(0,8,20,0.85); display:none; align-items:center; justify-content:center; z-index:200; }
  .modal-content{ background:rgba(0,0,25,0.8); border:1px solid rgba(134,241,255,0.3); border-radius:14px; padding:20px; max-width:460px; width:90%; color:#eaf6ff; box-shadow:0 0 20px rgba(250,216,96,0.4); text-align:center; }
  .modal-content h2{ margin-top:0; margin-bottom:12px; font-size:1.6rem; }
  .modal-content p{ margin:6px 0; font-size:1rem; }
  .modal-content button{ margin-top:14px; padding:8px 20px; border-radius:20px; border:2px solid #6accfd; background:rgba(106,204,253,0.25); color:#eaf6ff; font-size:1rem; cursor:pointer; transition: background .3s; }
  .modal-content button:hover{ background: rgba(250,216,96,0.25); box-shadow: 0 0 12px rgba(250,216,96,0.45), 0 0 18px rgba(106,204,253,0.4); }
  .modal-buttons{ display:flex; justify-content:center; gap:12px; margin-top:14px; }
</style>
</head>
<body>
<div id="err"></div>
<div id="stars"></div><div id="stars2"></div><div id="stars3"></div>

  <!-- Ambient music to set the mood -->
  <audio id="ambient" src="sounds/choose.mp3" loop autoplay muted playsinline preload="auto"></audio>
  <!-- Intro overlay message -->
  <div class="overlay" id="overlay">
    <h1>Choose your path…</h1>
  </div>

<div id="app">
  <div class="stage">
    <div class="cards" id="cards"></div>
    <button class="nav-btn nav-left" id="prevBtn" aria-label="Previous">&lt;</button>
    <button class="nav-btn nav-right" id="nextBtn" aria-label="Next">&gt;</button>
  </div>
  <div class="hero">
    <!-- Hero portrait and details -->
    <div class="image-container">
      <img id="heroImg" alt="" />
    </div>
    <h2 id="heroName">Select a class</h2>
    <p class="flavor" id="heroFlavor">Pick a character on the left to see details.</p>
    <!-- Character name input -->
    <div class="name-row">
      <label for="charName">Name</label>
      <input id="charName" type="text" placeholder="Enter your name" />
    </div>
    <!-- Ability selection chips -->
    <div class="abilities-selection" id="abilitiesSelection"></div>
    <!-- Points remaining -->
    <div class="points-remaining" id="pointsRemaining">2 points remaining</div>
    <!-- Attributes grid -->
    <div class="attributes" id="attrs"></div>
    <div class="footer">
      <button id="continueBtn" disabled>Continue</button>
    </div>
  </div>
</div>

  <!-- Summary modal -->
  <div id="summaryModal" class="modal">
    <div class="modal-content">
      <h2>Character Summary</h2>
      <p><strong>Name:</strong> <span id="sumName">—</span></p>
      <p><strong>Class:</strong> <span id="sumClass">—</span></p>
      <p><strong>Abilities:</strong> <span id="sumAbilities">—</span></p>
      <div class="modal-buttons">
        <button id="backBtn">Back</button>
        <button id="proceedBtn">Proceed</button>
      </div>
    </div>
  </div>

<!-- Load class and ability data -->
<script src="choose.data.js"></script>
<script>
    /*
     * Load normalized class and ability data before running the main script.
     * This file defines window.CLASSES and window.ABILITY_COSTS which we rely on below.
     */
(function(){'use strict';
  window.addEventListener('error', function(e){ var el=document.getElementById('err'); el.style.display='block'; el.textContent='JS-Fehler: '+e.message+' ('+e.filename+':'+e.lineno+')'; });

  // Use classes defined in choose.data.js if available; otherwise fall back to this built-in array.
  var CLASSES = [
      { name: "Warrior", slug: "warrior", role: "Frontliner", flavor: "A hardened fighter who holds the line with blade and grit.", abilities: ["Sword Slash", "Stand Firm", "Curve Slash"], base: { STR:10, AGI:7, END:10, SPC:6, INT:5, WIS:6 }, img: "warrior.jpg" },
      { name: "Berserker", slug: "berserker", role: "Frontliner", flavor: "A wild fighter whose fury peaks when wounded.", abilities: ["Fury", "Wild Hit", "War Cry"], base: { STR:11, AGI:7, END:10, SPC:6, INT:5, WIS:5 }, img: "berserker.jpg" },
      { name: "Samurai", slug: "samurai", role: "Frontliner", flavor: "A disciplined swordmaster, swift and precise.", abilities: ["Iaijutsu", "Focus", "Calm Strike"], base: { STR:9, AGI:9, END:7, SPC:7, INT:5, WIS:7 }, img: "samurai.jpg" },
      { name: "Spearfighter", slug: "spearfighter", role: "Frontliner", flavor: "A relentless lancer who pierces armor and resolve.", abilities: ["Thrust", "Jab", "Spear Swipe"], base: { STR:8, AGI:8, END:8, SPC:8, INT:5, WIS:7 }, img: "spearfighter.jpg" },
      { name: "Dragon Knight", slug: "dragonknight", role: "Frontliner", flavor: "A knight armored in scales and draconic might.", abilities: ["Drake Jab", "Scale Armor", "Drake Roar"], base: { STR:10, AGI:6, END:10, SPC:6, INT:6, WIS:6 }, img: "dragonknight.jpg" },

      { name: "Ninja", slug: "ninja", role: "Trickster", flavor: "A shadow in motion—swift, elusive, decisive.", abilities: ["Kunai Toss", "Smoke Puff", "Soft Step"], base: { STR:6, AGI:11, END:6, SPC:9, INT:6, WIS:6 }, img: "ninja.jpg" },
      { name: "Shadowrunner", slug: "shadowrunner", role: "Trickster", flavor: "A master infiltrator who slips through darkness and walls alike.", abilities: ["Shadow Dagger", "Shadow Veil", "Shadow Step"], base: { STR:6, AGI:10, END:6, SPC:10, INT:6, WIS:6 }, img: "shadowrunner.jpg" },
      { name: "Acrobat", slug: "acrobat", role: "Trickster", flavor: "Daring footwork and spinning strikes that bewilder foes.", abilities: ["Somersault Strike", "Spin Kick", "Flip"], base: { STR:6, AGI:11, END:7, SPC:8, INT:6, WIS:6 }, img: "acrobat.jpg" },
      { name: "Chainfighter", slug: "chainfighter", role: "Trickster", flavor: "Steel and motion—chains that bind and bite.", abilities: ["Chain Throw", "Chain Whip", "Chain Bind"], base: { STR:8, AGI:9, END:8, SPC:8, INT:5, WIS:6 }, img: "chainfighter.jpg" },
      { name: "Guardian", slug: "guardian", role: "Defender", flavor: "Unshakable stance; danger is welcomed and absorbed.", abilities: ["Guard Stance", "Challenge", "Steadfast"], base: { STR:9, AGI:6, END:11, SPC:7, INT:5, WIS:6 }, img: "guardian.jpg" },

      { name: "Pyromancer", slug: "pyromancer", role: "Arcane Destroyer", flavor: "Flame obeys; ash is a kind of certainty.", abilities: ["Flame Snap", "Fire Flicker", "Cinder Puff", "Ember Glint"], base: { STR:7, AGI:6, END:6, SPC:8, INT:11, WIS:6 }, img: "pyromancer.jpg" },
      { name: "Storm Mage", slug: "stormmage", role: "Arcane Destroyer", flavor: "Thunder answers the call; wind carries the strike.", abilities: ["Spark", "Breeze", "Chain Spark", "Breezy Flow"], base: { STR:5, AGI:7, END:6, SPC:9, INT:10, WIS:7 }, img: "stormmage.jpg" },
      { name: "Cryomancer", slug: "cryomancer", role: "Arcane Destroyer", flavor: "Winter sculpted into shards and silence.", abilities: ["Frost Pebble", "Icicle", "Cold Gust", "Cool Mist"], base: { STR:6, AGI:6, END:6, SPC:9, INT:10, WIS:7 }, img: "cryomancer.jpg" },
      { name: "Crystal Mage", slug: "crystalmage", role: "Arcane Destroyer", flavor: "Crystalline focus—barriers, blades, and refracted will.", abilities: ["Shard", "Shard Guard", "Shard Shield", "Shard Spike"], base: { STR:5, AGI:6, END:6, SPC:9, INT:10, WIS:8 }, img: "crystalmage.jpg" },
      { name: "Blood Mage", slug: "bloodmage", role: "Arcane Destroyer", flavor: "Life pays the price; devastation collects the debt.", abilities: ["Blood Gift", "Vein Grip", "Sanguine Burst", "Drain"], base: { STR:6, AGI:8, END:6, SPC:8, INT:10, WIS:6 }, img: "bloodmage.jpg" },

      { name: "Spirit Caller", slug: "spiritcaller", role: "Mystic", flavor: "Whispers to the dead; ancestors answer with power.", abilities: ["Ancestor Whisper", "Spirit Pulse", "Spirit Friend", "Ancestor's Aid"], base: { STR:5, AGI:6, END:6, SPC:8, INT:8, WIS:11 }, img: "spiritcaller.jpg" },
      { name: "Shaman", slug: "shaman", role: "Mystic", flavor: "Spirits and totems woven into rites of battle.", abilities: ["Totem Place", "Spirit Chant", "Great Totem", "Minor Rain"], base: { STR:6, AGI:6, END:7, SPC:8, INT:7, WIS:10 }, img: "shaman.jpg" },
      { name: "Oracle", slug: "oracle", role: "Mystic", flavor: "Sight bends fate; outcomes reveal themselves early.", abilities: ["Glimpse", "Coin Toss", "Hint", "Bend Fate"], base: { STR:5, AGI:5, END:6, SPC:9, INT:8, WIS:11 }, img: "oracle.jpg" },
      { name: "Runemaster", slug: "runemaster", role: "Mystic", flavor: "Sigils of power etched to weaken or detonate.", abilities: ["Rune Spark", "Rune Dull", "Rune Pop", "Rune Guard"], base: { STR:5, AGI:6, END:6, SPC:9, INT:9, WIS:9 }, img: "runemaster.jpg" },
      { name: "Dreamwalker", slug: "dreamwalker", role: "Mystic", flavor: "Steps between minds; dreams obey the daring.", abilities: ["Sleep Mist", "Mirage", "Walk in Dream", "Mind Glance"], base: { STR:5, AGI:6, END:7, SPC:8, INT:8, WIS:10 }, img: "dreamwalker.jpg" },

      { name: "Beastcaller", slug: "beastcaller", role: "Wild", flavor: "Primal bonds call loyal companions to your side.", abilities: ["Summon Companion", "Beast Instinct", "Big Beast"], base: { STR:7, AGI:7, END:7, SPC:8, INT:6, WIS:9 }, img: "beastcaller.jpg" },
      { name: "Druid", slug: "druid", role: "Wild", flavor: "Bark and thorn, fang and form—nature answers.", abilities: ["Thorn Whip", "Beast Form (Small)", "Tree Form"], base: { STR:6, AGI:6, END:8, SPC:7, INT:7, WIS:10 }, img: "druid.jpg" },
      { name: "Insect Tamer", slug: "insecttamer", role: "Wild", flavor: "Crawling legions directed with uncanny calm.", abilities: ["Swarm Rush", "Crawling Cover", "Insect Pulse"], base: { STR:6, AGI:7, END:7, SPC:9, INT:7, WIS:8 }, img: "insecttamer.jpg" },
      { name: "Lycanthrope", slug: "lycanthrope", role: "Wild", flavor: "The beast within—claws, howl, and terrible speed.", abilities: ["Claw Swipe", "Howl", "Wolf Form"], base: { STR:10, AGI:8, END:9, SPC:6, INT:5, WIS:6 }, img: "lycanthrope.jpg" },
      { name: "Dragonborn", slug: "dragonborn", role: "Wild", flavor: "Blood of dragons—breath of elements.", abilities: ["Dragon Breath", "Dragon Scales", "Mighty Breath"], base: { STR:9, AGI:7, END:8, SPC:7, INT:6, WIS:7 }, img: "dragonborn.jpg" },

      { name: "Bard", slug: "bard", role: "Specialist", flavor: "Words that embolden allies and unnerve foes.", abilities: ["Song of War", "Jeer Song", "Heroic Note"], base: { STR:6, AGI:7, END:8, SPC:8, INT:7, WIS:8 }, img: "bard.jpg" },
      { name: "Alchemist", slug: "alchemist", role: "Specialist", flavor: "Bottled chaos—bombs, brews, and quick fixes.", abilities: ["Throw Potion", "Quick Mix", "Big Flask"], base: { STR:6, AGI:7, END:7, SPC:9, INT:9, WIS:6 }, img: "alchemist.jpg" },
      { name: "Technomancer", slug: "technomancer", role: "Specialist", flavor: "Where circuits meet sigils and sparks become spells.", abilities: ["Spark Shot", "Gadget", "Toy Drone"], base: { STR:6, AGI:7, END:6, SPC:9, INT:10, WIS:6 }, img: "technomancer.jpg" },
      { name: "Witch Hunter", slug: "witchhunter", role: "Specialist", flavor: "Wards and bolts to break the will of witches.", abilities: ["Purify Bolt", "Resistance Field", "Seal Mark"], base: { STR:7, AGI:7, END:7, SPC:9, INT:6, WIS:8 }, img: "witchhunter.jpg" },
      { name: "Blood Knight", slug: "bloodknight", role: "Specialist", flavor: "A cursed blade that drinks deep and stands unbroken.", abilities: ["Blade Sacrifice", "Blood Shackles", "Blood Rush"], base: { STR:10, AGI:7, END:10, SPC:6, INT:5, WIS:6 }, img: "bloodknight.jpg" }
    ];

  var ABILITY_COSTS = {};

  // If choose.data.js defines CLASSES and ABILITY_COSTS, prefer those
  if (window.CLASSES && window.CLASSES.length) {
    CLASSES = window.CLASSES;
  }
  if (window.ABILITY_COSTS) {
    ABILITY_COSTS = window.ABILITY_COSTS;
  }

  function $(id){ return document.getElementById(id); }
  // DOM element references
  var cardsEl = $('cards');
  var prevBtn = $('prevBtn'), nextBtn = $('nextBtn');
  // New hero element references
  var heroImg = $('heroImg'), heroName = $('heroName'), heroFlavor = $('heroFlavor');
  var abilitiesSelectionEl = $('abilitiesSelection');
  var attrsContainer = $('attrs');
  var pointsRemainingEl = $('pointsRemaining');
  var continueBtn = $('continueBtn');
  var charNameInput = $('charName');
  // Summary modal references
  var summaryModal = $('summaryModal');
  var sumNameSpan = $('sumName'), sumClassSpan = $('sumClass'), sumAbilitiesSpan = $('sumAbilities');
  var proceedBtn = $('proceedBtn'), backBtn = $('backBtn');
  // Carousel state
  var idx = 0, lock = false;
  // Character state
  var selected = null;
  var remainingPoints = 2;
  var currentValues = {};
  var selectedAbilities = [];

  function ensureImg(el, cls){
    var paths=[];
    if (cls.img){
      var base=cls.img.replace(/\.(jpg|jpeg|png|webp)$/i,'');
      ['.jpg','.jpeg','.png','.webp'].forEach(function(ex){ paths.push('images/'+base+ex); });
      paths.unshift('images/'+cls.img);
    }
    if (cls.slug){
      ['.jpg','.jpeg','.png','.webp'].forEach(function(ex){ paths.push('images/'+cls.slug+ex); });
      if(cls.slug==='pyromancer'){
        ['.jpg','.jpeg','.png','.webp'].forEach(function(ex){ paths.push('images/pyro'+ex); });
      }
    }
    paths.push('images/placeholder.jpg');
    var i=0; el.onerror=function(){ i++; if(i<paths.length){ el.src=paths[i]; } };
    el.src=paths[0];
  }

  function renderCards(){
    cardsEl.innerHTML='';
    if(!CLASSES || !CLASSES.length) return;
    var n=CLASSES.length;
    var prev=((idx-1+n)%n), next=((idx+1)%n);
    for(var i=0;i<n;i++){
      var cls=CLASSES[i];
      var role=(i===idx?'center':(i===prev||i===next?'side':'hidden'));
      var card=document.createElement('div');
      card.className='card '+role;
      var th=document.createElement('div'); th.className='thumb';
      var im=document.createElement('img'); ensureImg(im, cls); th.appendChild(im);
      var nm=document.createElement('div'); nm.className='name'; nm.textContent=cls.name||'';
      card.appendChild(th); card.appendChild(nm);
      (function(j){ card.addEventListener('click', function(){ if(j===idx) return; goto(j); }); })(i);
      if(role!=='hidden') cardsEl.appendChild(card);
    }
  }

  // ================================
  // Character management and UI helpers
  // ================================

  // Persist the character into storage so other pages can read it
  function autoSaveCharacter() {
    if (!selected) return;
    var charName = (charNameInput && charNameInput.value || '').trim();
    if (!charName) return;
    if (remainingPoints < 0) return;
    var character = {
      class: selected.slug,
      className: selected.name,
      name: charName,
      attributes: currentValues,
      abilities: selectedAbilities,
      classImg: selected.img || null
    };
    try {
      localStorage.setItem('character', JSON.stringify(character));
      sessionStorage.setItem('character', JSON.stringify(character));
      localStorage.setItem('character.name', character.name);
      localStorage.setItem('character.className', character.className);
      localStorage.setItem('character.class', character.class);
      localStorage.setItem('character.abilities', JSON.stringify(character.abilities));
      localStorage.setItem('character.attributes', JSON.stringify(character.attributes));
      localStorage.setItem('character.stats', JSON.stringify(character.attributes));
    } catch (err) {}
  }

  // Build the attribute grid with plus buttons
  function buildAttributesUI() {
    if (!attrsContainer) return;
    attrsContainer.innerHTML = '';
    var statLabels = {
      STR: 'Strength',
      AGI: 'Agility',
      END: 'Endurance',
      SPC: 'Spatial Awareness',
      INT: 'Intelligence',
      WIS: 'Wisdom'
    };
    ['STR','AGI','END','SPC','INT','WIS'].forEach(function(attr) {
      var wrapper = document.createElement('div');
      wrapper.className = 'attr';
      var label = document.createElement('span'); label.className = 'label'; label.textContent = statLabels[attr] || attr;
      var value = document.createElement('span'); value.className = 'value'; value.id = 'val_' + attr; value.textContent = currentValues[attr];
      var btn = document.createElement('button'); btn.className = 'plus'; btn.textContent = '+';
      btn.addEventListener('click', function() {
        incrementAttr(attr, value, btn);
        autoSaveCharacter();
      });
      wrapper.appendChild(label);
      wrapper.appendChild(value);
      wrapper.appendChild(btn);
      attrsContainer.appendChild(wrapper);
      updateButtonState(btn);

      // Also allow clicking anywhere on the attribute row to increment,
      // so users can easily tap the entire row instead of the tiny plus icon.
      // Do not increment if clicking on the disabled plus button.
      wrapper.addEventListener('click', function(ev) {
        // If the click originated from the plus button, it has already been handled.
        // Otherwise handle increment if points remain.
        if (ev.target && ev.target.tagName.toLowerCase() === 'button') {
          return;
        }
        incrementAttr(attr, value, btn);
        autoSaveCharacter();
      });
    });
  }

  // Increment a single attribute and update remaining points
  function incrementAttr(attr, valueEl, btn) {
    if (remainingPoints <= 0) return;
    currentValues[attr] = (currentValues[attr] || 0) + 1;
    remainingPoints--;
    valueEl.textContent = currentValues[attr];
    pointsRemainingEl.textContent = remainingPoints + ' points remaining';
    // Update plus buttons based on remaining points
    var plusBtns = attrsContainer.querySelectorAll('button.plus');
    plusBtns.forEach(function(p) { updateButtonState(p); });
    updateContinueState();
  }

  // Enable/disable a plus button based on remaining points
  function updateButtonState(btn) {
    btn.disabled = (remainingPoints <= 0);
  }

  // Build the ability selection chips for the chosen class
  function buildAbilitiesUI(cls) {
    if (!abilitiesSelectionEl) return;
    abilitiesSelectionEl.innerHTML = '';
    selectedAbilities = [];
    if (!cls) return;
    var list = cls.abilities || [];
    list.forEach(function(abName) {
      // Wrap input and label in a container
      var wrapper = document.createElement('label');
      wrapper.className = 'ability-chip';
      // Hidden checkbox to track selection
      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = abName;
      checkbox.style.display = 'none';
      // Label text
      var nameSpan = document.createElement('span');
      nameSpan.textContent = abName;
      wrapper.appendChild(nameSpan);
      // Cost badge
      var costData = ABILITY_COSTS ? ABILITY_COSTS[abName] : null;
      if (costData) {
        var badge = document.createElement('span');
        badge.className = 'ab-cost';
        var text = formatCostString(costData);
        if (costData.alt) {
          text += ' / ' + formatCostString(costData.alt);
        }
        badge.textContent = text;
        wrapper.appendChild(badge);
      }
      // Append checkbox last so it doesn't disrupt flex layout
      wrapper.appendChild(checkbox);
      // Change handler: toggle ability selection
      checkbox.addEventListener('change', function() {
        var checked = checkbox.checked;
        var idxSel = selectedAbilities.indexOf(abName);
        if (checked) {
          // If already two abilities selected, prevent extra selection
          if (selectedAbilities.length >= 2) {
            checkbox.checked = false;
            return;
          }
          if (idxSel < 0) selectedAbilities.push(abName);
        } else {
          if (idxSel >= 0) selectedAbilities.splice(idxSel, 1);
        }
        updateAbilityChipsState();
        updateContinueState();
        autoSaveCharacter();
      });
      abilitiesSelectionEl.appendChild(wrapper);
    });
    updateAbilityChipsState();
  }

  // Format a cost object into a displayable string
  function formatCostString(cost) {
    return cost.cost + ' ' + cost.type;
  }

  // Toggle selection of an ability chip
  function toggleAbility(abName, chipEl) {
    if (!chipEl) return;
    var idxSel = selectedAbilities.indexOf(abName);
    if (idxSel >= 0) {
      selectedAbilities.splice(idxSel, 1);
      chipEl.classList.remove('selected');
    } else {
      if (selectedAbilities.length >= 2) return;
      selectedAbilities.push(abName);
      chipEl.classList.add('selected');
    }
    updateAbilityChipsState();
    updateContinueState();
  }

  // Update the disabled state of ability chips
  function updateAbilityChipsState() {
    if (!abilitiesSelectionEl) return;
    var chips = abilitiesSelectionEl.querySelectorAll('.ability-chip');
    var disable = selectedAbilities.length >= 2;
    chips.forEach(function(chip) {
      var checkbox = chip.querySelector('input[type="checkbox"]');
      var isChecked = checkbox && checkbox.checked;
      // Add or remove selected class based on checkbox
      if (isChecked) {
        chip.classList.add('selected');
      } else {
        chip.classList.remove('selected');
      }
      // Disable chips when two abilities selected, except already selected ones
      if (!isChecked && disable) {
        chip.classList.add('disabled');
      } else {
        chip.classList.remove('disabled');
      }
    });
  }

  // Update the state of the Continue button
  function updateContinueState() {
    var nameOk = (charNameInput && charNameInput.value && charNameInput.value.trim().length > 0);
    var pointsOk = (remainingPoints === 0);
    var abilOk = (selectedAbilities.length >= 2);
    if (nameOk && pointsOk && abilOk && selected) {
      continueBtn.disabled = false;
    } else {
      continueBtn.disabled = true;
    }
  }

  // Display the summary modal with character details
  function showSummary() {
    sumNameSpan.textContent = (charNameInput && charNameInput.value.trim()) || '—';
    sumClassSpan.textContent = selected ? (selected.name || '—') : '—';
    sumAbilitiesSpan.textContent = selectedAbilities && selectedAbilities.length ? selectedAbilities.join(', ') : '—';
    if (summaryModal) summaryModal.style.display = 'flex';
  }

  // Hide the summary modal
  function hideSummary() {
    if (summaryModal) summaryModal.style.display = 'none';
  }

  // Proceed to overview page
  function proceedToOverview() {
    autoSaveCharacter();
    try { sessionStorage.setItem('ambientUnlock','1'); } catch (e) {}
    window.location.href = 'overview.html';
  }

  // When a new class is selected, update the hero panel
  function selectClass(cls) {
    selected = cls;
    if (cls) {
      ensureImg(heroImg, cls);
      heroName.textContent = cls.name || '—';
      heroFlavor.textContent = cls.flavor || cls.description || cls.desc || '';
      // Reset state
      remainingPoints = 2;
      pointsRemainingEl.textContent = remainingPoints + ' points remaining';
      currentValues = Object.assign({}, cls.base || {});
      buildAttributesUI();
      buildAbilitiesUI(cls);
      updateContinueState();
    } else {
      // Clear hero panel
      heroImg.src = '';
      heroName.textContent = '—';
      heroFlavor.textContent = '';
      abilitiesSelectionEl.innerHTML = '';
      attrsContainer.innerHTML = '';
      pointsRemainingEl.textContent = '2 points remaining';
      continueBtn.disabled = true;
    }
    autoSaveCharacter();
  }


  function renderRight() {
    // When the carousel selects a new card, update hero panel
    var cls = CLASSES[idx] || null;
    selectClass(cls);
  }

  // Event listeners for UI interactions
  if (continueBtn) continueBtn.addEventListener('click', function() {
    showSummary();
  });
  if (backBtn) backBtn.addEventListener('click', function() {
    hideSummary();
  });
  if (proceedBtn) proceedBtn.addEventListener('click', function() {
    proceedToOverview();
  });
  if (charNameInput) charNameInput.addEventListener('input', function() {
    updateContinueState();
  });

  function goto(i){
    if(lock) return; lock=true;
    idx=(i+CLASSES.length)%CLASSES.length;
    renderCards(); renderRight();
    setTimeout(function(){ lock=false; }, 120);
  }

  if(nextBtn) nextBtn.addEventListener('click', function(){ goto(idx+1); });
  if(prevBtn) prevBtn.addEventListener('click', function(){ goto(idx-1); });

  document.addEventListener('DOMContentLoaded', function(){
    idx = 0;
    renderCards();
    // Select the first class on load to populate hero panel
    if (CLASSES && CLASSES.length) selectClass(CLASSES[idx]);
  });

  // Fade out overlay and unmute ambient music on window load
  window.addEventListener('load', function() {
    setTimeout(function() {
      var ov = document.getElementById('overlay');
      if (ov) {
        ov.style.opacity = '0';
        ov.style.filter = 'blur(0)';
        ov.style.transform = 'scale(1)';
        setTimeout(function() { if (ov.parentElement) ov.remove(); }, 1400);
      }
    }, 800);
    try {
      var ambient = document.getElementById('ambient');
      if (ambient) {
        ambient.volume = 0.01;
        var unlocked = (sessionStorage.getItem('ambientUnlock') === '1');
        if (unlocked) ambient.muted = false;
        ambient.play().then(function() {
          if (!unlocked) setTimeout(function(){ ambient.muted = false; }, 50);
        }).catch(function(){});
      }
    } catch (e) {}
  });

  // Attempt to play ambient music on first user interaction (click or keypress).
  function tryPlayAmbient() {
    var amb = document.getElementById('ambient');
    if (amb) {
      amb.volume = 0.25;
      amb.play().then(function() {
        amb.muted = false;
      }).catch(function() {
        // Autoplay might still be blocked; ignore errors here
      });
    }
  }
  // Only trigger ambient playback once per page load
  document.addEventListener('click', function handler() {
    tryPlayAmbient();
    document.removeEventListener('click', handler);
  });
  document.addEventListener('keydown', function handler() {
    tryPlayAmbient();
    document.removeEventListener('keydown', handler);
  });

  // Generic click handler to show summary when the continue button is activated
  document.addEventListener('click', function(e) {
    var tgt = e.target;
    // If user clicks the continue button and it's enabled, display the summary
    if (tgt && tgt.id === 'continueBtn' && continueBtn && !continueBtn.disabled) {
      e.preventDefault();
      showSummary();
    }
  });
})();
</script>
</body>
</html>
